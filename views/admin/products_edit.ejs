<%- include('../layouts/flash') %>
<h1>Modifica prodotto</h1>

<form method="post" action="/admin/products/<%= p.id %>" enctype="multipart/form-data" class="form">
  <label>Titolo
    <input type="text" name="title" value="<%= p.title %>" required />
  </label>

  <label>Categoria
    <select name="category_id" required>
      <% (cats||[]).forEach(c => { %>
        <option value="<%= c.id %>" <%= p.category_id===c.id?'selected':'' %>><%= c.name %></option>
      <% }) %>
    </select>
  </label>

  <label>Prezzo (€)
    <input type="number" step="0.01" min="0" name="price" value="<%= (p.price_cents/100).toFixed(2) %>" required />
  </label>

  <label>Descrizione
    <textarea name="description" rows="6"><%= p.description||'' %></textarea>
  </label>

  <label>
    <input type="checkbox" name="is_active" value="1" <%= p.is_active?'checked':'' %> /> Pubblicato
  </label>

  <fieldset>
    <legend>Copertina attuale</legend>
    <% if (p.image) { %>
      <img src="<%= p.image %>" alt="cover" style="max-width:260px;border-radius:8px;border:1px solid #1f2937" />
    <% } else { %>
      <p>Nessuna copertina</p>
    <% } %>
    <div class="grid2">
      <label>Nuovo file
        <input type="file" name="image" accept="image/*" />
      </label>
      <label>Oppure nuova URL
        <input type="url" name="image_url" placeholder="https://…" />
      </label>
    </div>
  </fieldset>

  <fieldset>
    <legend>Aggiungi immagini alla galleria</legend>
    <label>File multipli
      <input type="file" name="images" accept="image/*" multiple />
    </label>
    <div class="or">oppure/insieme</div>
    <label>URL (una per riga)
      <textarea name="image_urls" rows="5" placeholder="https://…\nhttps://…"></textarea>
    </label>
  </fieldset>

  <button class="btn" type="submit">Salva modifiche</button>
  <a class="btn" href="/admin/products">Indietro</a>
</form>

<% if (images && images.length) { %>
  <h2>Galleria esistente</h2>
  <div class="grid">
    <% images.forEach(img => { %>
      <figure class="tile">
        <img src="<%= img.url %>" alt="" />
        <form method="post" action="/admin/products/<%= p.id %>/images/<%= img.id %>/delete" onsubmit="return confirm('Rimuovere questa immagine?');">
          <button type="submit" class="btn btn-danger">Rimuovi</button>
        </form>
      </figure>
    <% }) %>
  </div>
<% } %>

<style>
.form{display:grid;gap:12px;max-width:820px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:12px}
.tile{border:1px solid #1f2937;border-radius:10px;padding:8px;display:grid;gap:8px}
.tile img{width:100%;height:160px;object-fit:cover;border-radius:8px}
label{display:grid;gap:6px}
fieldset{border:1px solid #1f2937;border-radius:10px;padding:12px;display:grid;gap:8px}
legend{padding:0 6px}
.or{opacity:.7;font-size:.9em}
.btn{padding:10px 14px;border-radius:8px;background:#374151;color:#fff;border:0;cursor:pointer;text-decoration:none;width:max-content}
.btn-danger{background:#b91c1c}
@media(max-width:800px){.grid2{grid-template-columns:1fr}}
</style>
